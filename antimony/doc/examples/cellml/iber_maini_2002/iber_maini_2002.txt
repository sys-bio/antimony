//Created by libAntimony v1.3
model iber_maini_2002_version01__environment(time_, rho, d, n)

  // Assignment Rules:
  rho := 24.0 / 6.5 * ln( 2.0 );
  d := 12.0 * ln( 2.0 );
end

model iber_maini_2002_version01__recycling_probability(pr, pr1, pr2, Ag_min, Ag, n, K_AgAb, C1, C2, time_)

  // Assignment Rules:
  pr := 0.6 + 0.2 * (power( Ag , n ) / (power( Ag , n ) + power( Ag_min , n )));
  pr1 := 0.95;
  pr2 := 0.7 * eta;
  eta := piecewise( K_AgAb / ( C1 + C2 ) , K_AgAb / ( C1 + C2 ) < 1.0 , 1.0 );
end

model iber_maini_2002_version01__antigens(Ag_min, Ag, k_on, C, Cs, Ab, time_)

  // Rate Rules:
  Ag' = -(( u * k * C + u * Cs * ( 1.0 - k ))) * Ag - k_on * Ag * Ab;

  // Variable initializations:
  Ag = 2500.0;
  k_on = 5.0E-13;
  k = 0.0;
  u = 1.0E-4;
end

model iber_maini_2002_version01__antibodies(Ab, k_on, AFC, Ag, time_)

  // Rate Rules:
  Ab' = beta * AFC - k_on * Ag * Ab;

  // Variable initializations:
  beta = 1.0E8;
end

model iber_maini_2002_version01__antigen_antibody_complexes(theta, K_AgAb, k_on, Ab, Ag, C1, C2, time_)

  // Assignment Rules:
  theta := 0.3 * ( Ag / ( C1 + C2 )) * ( Ag / ( Ag + K_AgAb ));

  // Rate Rules:
  K_AgAb' = k_on * Ag * Ab;
end

model iber_maini_2002_version01__selection_probability_of_centrocytes(s, s1, s2, Ag_min, Ag, n, delta_c, pr, m, d, C1, C2, time_)

  // Assignment Rules:
  s := sc - ( h + f * (power( Ag_min , n ) / (power( Ag_min , n ) + power( Ag , n ))));
  s1 := 0.01 + 0.09 * zeta;
  s2 := 0.1 + 0.85 * zeta;
  sc := delta_c / ( d * ( 2.0 * pr * m - 1.0 ) + delta_c );
  zeta := Ag / ( C1 + C2 );

  // Variable initializations:
  h = 0.07;
  f = 0.35;
end

model iber_maini_2002_version01__centroblasts(B, B1, B2, time_, pr, pr1, pr2, rho, Cs1, Cs2)

  // Rate Rules:
  B' = rho * B;
  B1' = pr1 * rho * Cs1 - rho * B1;
  B2' = pr2 * rho * Cs2 - rho * B2;
end

model iber_maini_2002_version01__centrocytes(C, C1, C2, m, delta_c, time_, rho, B, B1, B2, d, s, s1, s2)

  // Assignment Rules:
  delta_c := 1.5 * ln( 2.0 );
  mu := d * s + delta_c * ( 1.0 - s );
  mu1 := d * s1 + delta_c * ( 1.0 - s1 );
  mu2 := d * s2 + delta_c * ( 1.0 - s2 );
  M11 := 1.0 - M21;
  M12 := 1.0 - M22;

  // Rate Rules:
  C' = 2.0 * rho * m * B - mu * C;
  C1' = 2.0 * rho * m * ( M11 + B1 ) * ( M12 + B2 ) - mu1 * C1;
  C2' = 2.0 * rho * m * ( M21 + B1 ) * ( M22 + B2 ) - mu2 * C2;

  // Variable initializations:
  m = 0.72;
end

model iber_maini_2002_version01__selected_centrocytes(Cs, Cs1, Cs2, time_, d, s, s1, s2, rho, C, C1, C2)

  // Rate Rules:
  Cs' = d * s * C - rho * Cs;
  Cs1' = d * s1 * C1 - rho * Cs1;
  Cs2' = d * s2 * C2 - rho * Cs2;
end

model iber_maini_2002_version01__memory_cells(time_, rho, pr, pr1, pr2, Cs, Cs1, Cs2, theta)

  // Rate Rules:
  M' = ( 1.0 - theta ) * rho * ( 1.0 - pr ) * Cs;
  M1' = ( 1.0 - pr1 ) * Cs1;
  M2' = ( 1.0 - pr2 ) * Cs2;
end

model iber_maini_2002_version01__antibody_forming_cells(AFC, time_, pr, rho, Cs, theta)

  // Rate Rules:
  AFC' = theta * rho * ( 1.0 - pr ) * Cs;
end

model iber_maini_2002_version01____main()

  // Sub-modules, and any changes to those submodules:
  environment: iber_maini_2002_version01__environment(time_, rho, d, n);
  recycling_probability: iber_maini_2002_version01__recycling_probability(pr, pr1, pr2, Ag_min, Ag, n, K_AgAb, C1, C2, time_);
  antigens: iber_maini_2002_version01__antigens(Ag_min, Ag, k_on, C, Cs, Ab, time_);
  antibodies: iber_maini_2002_version01__antibodies(Ab, k_on, AFC, Ag, time_);
  antigen_antibody_complexes: iber_maini_2002_version01__antigen_antibody_complexes(theta, K_AgAb, k_on, Ab, Ag, C1, C2, time_);
  selection_probability_of_centrocytes: iber_maini_2002_version01__selection_probability_of_centrocytes(s, s1, s2, Ag_min, Ag, n, delta_c, pr, m, d, C1, C2, time_);
  centroblasts: iber_maini_2002_version01__centroblasts(B, B1, B2, time_, pr, pr1, pr2, rho, Cs1, Cs2);
  centrocytes: iber_maini_2002_version01__centrocytes(C, C1, C2, m, delta_c, time_, rho, B, B1, B2, d, s, s1, s2);
  selected_centrocytes: iber_maini_2002_version01__selected_centrocytes(Cs, Cs1, Cs2, time_, d, s, s1, s2, rho, C, C1, C2);
  memory_cells: iber_maini_2002_version01__memory_cells(time_, rho, pr, pr1, pr2, Cs, Cs1, Cs2, theta);
  antibody_forming_cells: iber_maini_2002_version01__antibody_forming_cells(AFC, time_, pr, rho, Cs, theta);
end
